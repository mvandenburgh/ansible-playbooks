---
- name: install nginx
  apt:
      name: nginx
      update_cache: yes
      state: latest
  become: yes
- name: start nginx
  service:
      name: nginx
      state: started
- name: erase current nginx config
  command: rm /etc/nginx/sites-enabled/default
  become: yes

- name: make new nginx config file
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: touch
  become: yes

- name: set up nginx conf for reverse proxy
  blockinfile:
    path: /etc/nginx/sites-enabled/default
    block: |
      server {
        listen 80 default_server;
        listen [::]:80 default_server;
        root /var/www/html;
        index index.html index.htm index.nginx-debian.html;
        server_name _;
        location / {
                proxy_pass http://localhost:3000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
        }
      }
  become: yes
